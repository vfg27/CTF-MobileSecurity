# Solution

## Description of the problem

The keyboard challenge requires to inspect the contents of a builded apk to obtain information about the app, execute a custom app in the server and obtain the flag.

## Solution

First of all, I debugged the apk in Android Studio. Inside the app I obtained the resources, the manifest and the .dex files. In these files, I can see the bytecode of the classes in Smali. To facilitate me the work, I used an app (jadx) to translate the Smali code to Java code. There I found the MainActivity class. In that class I learned that this app has three preferences files. When the MainActivity is created the flag is set via an intent inside the InfoKeyboardPrefs file and two of the three preference files are modified, setting a variable "debugmode" to false. Then, a timer is created. This Timer runs the checkForUpdates(Context ctx) method after 2 seconds and each 5 seconds. This method finds a zip file called "update.zip" in the external storage and tries to open it, if everything is correct it extract its contents. However, if an error occurs it shows the Exception that gave the error and if the "debugmode" variable of the KeyboardPrefs or the GlobalKeyboardPrefs is set to true, it prints the contents of this preferences files (including the flag).

With this information I decided to create a custom app that insert a inextractable .zip file called "update.zip" inside the external storage so an error occurs and the Exception is launched. In order to achieve this I created a regular text file, I created a .zip file with this text file and I put a password to the zip. I added it to the assets of my app and I wrote the code to insert it into the external storage. Trying this the exception is launched, provoking the execution of the code I want. However the contents of the preferences files are not shown because the "debugmode" variable is set to false in both files. I tried to modify this files with multiple commands, but I wasnt able to do it. So, I tried to create them in my own virtual device. I saw that they are created in the folder /data/data/package_name/shared_prefs. I downloaded one and I saw its contents:

	<?xml version='1.0' encoding='utf-8' standalone='yes' ?>
	<map>
    	<boolean name="debugmode" value="false" />
	</map>

My next try was modify the file GlobalKeyboardPrefs (for example) created with the com.mobisec.keyboard app with one made by by with the variable set to true. Again, my tries were useless because I didnÂ´t had the privileges to do it (even trying to change them with chmod 777). Investigating a bit more I found an attack called Zip Slip that allows to modify files without privileges with a malicious .zip file. The contents of this .zip should have this structure ../../../../../../../../../../../../../../../../data/data/com.mobisec.keyboard/shared_prefs\GlobalKeyboardPrefs.xml in order to go to the root of the filesystem and then to the folder I want to insert the file. In order to create this .zip file I had to download a python script from Github. Once I had the file I inserted it into the external storage under the name "update.zip" to make the target app open it and a few seconds later I insert my inextractable .zip file so the error occurs, the exception is launched and the flag is retreived from the contents of InfoKeyboardPrefs. I obtained the flag: MOBISEC{the_more_emoji_a_keyboard_has_the_more_secure_it_is}.

I needed to give read external storage and write external storage permissions.

## Optional Feedback

I think this challenge is very difficult. I had a lot of problems trying to insert the GlobalKeyboardPrefs in the system and finding that I had to use the Zip Slip was terrible. Then, creating the malicious zip file also was burdensome.