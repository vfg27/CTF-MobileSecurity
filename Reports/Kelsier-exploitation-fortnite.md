# Solution

## Description of the problem

The fortnite challenge requires to inspect the contents of a builded apk to obtain information about the app, execute a custom app in the server and obtain the flag.

## Solution

First of all, I debugged the apk in Android Studio. Inside the app I obtained the resources, the manifest and the .dex files. In these files, I can see the bytecode of the classes in Smali. To facilitate me the work, I used an app (jadx) to translate the Smali code to Java code. There I found the MainActivity class. In that class exists a method that sets the flag in the flag variable. When the Activity is created, the flag is set via an intent and it calls this method, then it creates a Timer object. It waits 1 second to download two files from the server, "fortnite.dex" and "sign.dat". Then, 1 second later and each 5 seconds it calls the function verifyAndRunCode(String codePath, String hashPath) if the hash of "sign.dat" is equal to the hash of the "fortnite.dex" file. This function it reads the "fortnite.dex" file, loads the Class Payload from it and runs the run() method in it. I tried to simulate this functionality from a custom app but I didnÂ´t recive any information after executing it in the server.
The description of the challenge is "Based on a true story." so I decided to look for information online. I found: "Just two days after Fortnite became available on Android, a Google engineer discovered a vulnerability that could let a hacker replace the app with a fake version of the game -- known in cybersecurity circles as a man-in-the-disk attack because it uses openings with external storage like your SD card to install malware.". With this information I decided to perform that attack. So, I created another app, with package name "com.mobisec.fortnitepayload" and a Class Payload (this information is obtained from the DexClassLoader). The Payload class must have the run() method (the one is going to be called after). This method must load the MainActivity of the app that invokes the function, must set accesible the flag variable and must print its contents. 
Once I have the app, I built it, and I unzip it, obtainig the file "classes3.dex" (the one that has the Payload app). I perform the SHA-256 hash of this file and I store it in a "sign.dat" file. After that I move the two file to the assets folder in my previous app.
In the MainActivity of this app I created an auxiliary method modDownloadFile() that executes the download of my two "malicious" files in the folder where the two original files are stored (I obtained the location from the first code execution), as "fortnite.dex" and "sign.dat". Finally, I declare a Timer inside the onCreate method of my MainActivity of 1500L and the I execute the method modDownloadFile() (I wait until the original files have been downloaded first so that I can replace them with mine and not the other way around). Making this I achieve that the app sets the flag, then downloads the good files from the server, then it downloads mine replacing the good ones, it loads my Payload class and executes my run() method, printing the flag: MOBISEC{players_gonna_play_mobisec_hackers_gonna_mobisec_it_up}.
I needed to give internet, read external storage and write external storage permissions.

## Optional Feedback

I think this challenge is very difficult. I had to look information about the Fortnite attack in order to know how to proceed. Also, after that, the concept of overwriting my files was a bit complicated.